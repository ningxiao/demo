<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>WASM PLAY H.265</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="format-detection" content="telephone=no, email=no" />
    <style>
        .sideBar {
            width: 852px;
            height: 28px;
            outline: 2px solid rgba(0, 0, 0, 0.9);
            background-color: rgba(243, 244, 246, 0.9);
        }

        #btnHome:hover {
            transform: scale(1.4);
        }

        #btnPlayVideo:hover {
            transform: scale(1.2);
        }

        #btnStopVideo:hover {
            transform: scale(1.2);
        }

        #btnFullscreen:hover {
            transform: scale(1.3);
        }

        #videoPlayer {
            width: 852px;
            height: 536px;
            background-color: white;
            border: 2px solid rgba(0, 0, 0, 0.9);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        #timeTrack {
            margin: auto;
            width: 540px;
            height: 28px;
            line-height: 28px;
        }

        #timeLabel {
            margin: auto;
            padding-top: 0;
            font-size: 14px;
            width: 200px;
            height: 28px;
            line-height: 28px;
        }

        .loadEffect {
            width: 120px;
            height: 120px;
            position: absolute;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            z-index: 999;
        }

        .loadEffect span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: lightgreen;
            position: absolute;
            animation: load 1.04s ease infinite;
        }

        @keyframes load {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0.2;
            }
        }

        .loadEffect span:nth-child(1) {
            left: 0;
            top: 50%;
            margin-top: -8px;
            animation-delay: 0.13s;
        }

        .loadEffect span:nth-child(2) {
            left: 14px;
            top: 14px;
            animation-delay: 0.26s;
        }

        .loadEffect span:nth-child(3) {
            left: 50%;
            top: 0;
            margin-left: -8px;
            animation-delay: 0.39s;
        }

        .loadEffect span:nth-child(4) {
            top: 14px;
            right: 14px;
            animation-delay: 0.52s;
        }

        .loadEffect span:nth-child(5) {
            right: 0;
            top: 50%;
            margin-top: -8px;
            animation-delay: 0.65s;
        }

        .loadEffect span:nth-child(6) {
            right: 14px;
            bottom: 14px;
            animation-delay: 0.78s;
        }

        .loadEffect span:nth-child(7) {
            bottom: 0;
            left: 50%;
            margin-left: -8px;
            animation-delay: 0.91s;
        }

        .loadEffect span:nth-child(8) {
            bottom: 14px;
            left: 14px;
            animation-delay: 1.04s;
        }

        .canvasDiv {
            width: 852px;
            height: 480px
        }

        #playCanvas {
            width: 852px;
            height: 480px;
        }

        .no-padding {
            margin-top: 0px;
            padding-right: 0px;
            padding-left: 0px;
            padding-top: 0px;
            height: 28px;
            display: inline-block;
            float: left;
            vertical-align: middle;
        }

        .track-padding {
            padding-left: 0px;
            width: 50px;
            height: 28px;
            display: inline-block;
            float: left;
        }

        .left {
            width: 28px;
            float: left;
        }

        .right {
            width: 28px;
            float: right;
        }

        #footer {
            height: 40px;
            line-height: 40px;
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: center;
            background: #F3F4F6;
            color: #000;
            font-family: Arial;
            font-size: 14px;
            letter-spacing: 1px;
        }

        #input {
            float: right;
            margin-right: 10px;
            margin-top: 3px;
            font-size: 14px;
        }

    </style>
</head>

<body>
    <div class="container" id="videoPlayer">
        <div class="sideBar">
            <span class="no-padding">
                <img src="pic/home.png" class="left" id="btnHome" title="Visit My Homepage"
                    onclick="window.open('https://github.com/ningxiao')" />
            </span>
            <div id="input">
                <select id="protocol" onchange="onSelectProto()">
                    <option value="http">HTTP</option>
                    <option value="ws">WS</option>
                    <option value="httpFlv">HTTP-FLV</option>
                </select>
                <input type="text" id="inputUrl" style="width:300px" />
            </div>
        </div>
        <div class="canvasDiv">
            <div class="loadEffect" id="loading" style="display:none;">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
            <canvas id="playCanvas" width="852" height="480"></canvas>
        </div>
        <div class="sideBar">
            <span class="no-padding">
                <img src="pic/play.png" class="left" id="btnPlayVideo" onclick="playVideo()" />
            </span>
            <span class="no-padding" style=" padding-left:5px;">
                <img src="pic/stop.png" class="left" id="btnStopVideo" onclick="stopVideo()" />
            </span>
            <span class="track-padding">
            </span>
            <span class="no-padding">
                <input id="timeTrack" type="range" value="0">
            </span>
            <span class="no-padding" style=" padding-left:10px;">
                <label id="timeLabel">00:00:00/00:00:00</label>
            </span>
            <span class="no-padding right">
                <img src="pic/fullscreen.png" class="right" id="btnFullscreen" onclick="fullscreen()" />
            </span>
        </div>
    </div>
    <script type='text/javascript' src="./js/wasm/common.js"></script>
    <script type='text/javascript' src="./js/pcm-player.js"></script>
    <script type='text/javascript' src="./js/webgl.js"></script>
    <script type='text/javascript' src="./js/player.js"></script>
    <script type='text/javascript'>
        var defaultProtos = {
            http: {
                url: "http://59.110.160.41/video/h265_high.mp4",
                waitLength: 512 * 1024,
                stream: false,
            }
        };
        let inputUrl = document.getElementById("inputUrl");
        inputUrl.value = defaultProtos["http"]["url"];
        //Player object.
        self.player = new Player();
        var loadingDiv = document.getElementById("loading");
        self.player.setLoadingDiv(loadingDiv);
        //Formated logger.
        var logger = new Logger("Page");

        function playVideo() {
            var protoList = document.getElementById("protocol");
            var proto = protoList.options[protoList.selectedIndex].value;
            var protoObj = defaultProtos[proto];
            var inputUrl = document.getElementById("inputUrl");
            var url = inputUrl.value;
            var el = document.getElementById("btnPlayVideo");
            var currentState = self.player.getState();
            if (currentState == playerStatePlaying) {
                el.src = "pic/play.png";
            } else {
                el.src = "pic/pause.png";
            }
            if (currentState != playerStatePlaying) {
                const canvasId = "playCanvas";
                var canvas = document.getElementById(canvasId);
                if (!canvas) {
                    logger.logError("No Canvas with id " + canvasId + "!");
                    return false;
                }

                self.player.play(url, canvas, function (e) {
                    console.log("play error " + e.error + " status " + e.status + ".");
                    if (e.error == 1) {
                        logger.logInfo("Finished.");
                    }
                }, protoObj.waitLength, protoObj.stream);

                var timeTrack = document.getElementById("timeTrack");
                var timeLabel = document.getElementById("timeLabel");
                self.player.setTrack(timeTrack, timeLabel);
            } else {
                self.player.pause();
            }

            return true;
        }

        function stopVideo() {
            self.player.stop();
            var button = document.getElementById("btnPlayVideo");
            button.value = "Play";
            button.src = "pic/play.png";
        }

        function fullscreen() {
            self.player.fullscreen();
        }

        function onSelectProto() {
            var protoList = document.getElementById("protocol");
            var proto = protoList.options[protoList.selectedIndex].value;
            var protoObj = defaultProtos[proto];
            var inputUrl = document.getElementById("inputUrl");
            inputUrl.value = protoObj["url"];
        }

    </script>
</body>

</html>
