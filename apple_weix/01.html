<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>破茧重生</title>
		<meta name="viewport" content="width=640, user-scalable=no,target-densityDpi=device-dpi">
		<style type="text/css">
			*{ margin:0; padding:0;}
			html{ overflow:hidden;}
			body{ font-family:Tahoma,Arial,Roboto,"Droid Sans","Helvetica Neue","Droid Sans Fallback","Heiti SC",sans-self;}
			li{ list-style:none;}
			#main{ width:640px; height:auto; position:relative; overflow:hidden;}
			#canvas{ width:100%; height:100%; position:absolute; left:0; top:0; z-index:10;}
			#list{}
			#list > li{ width:100%; height:100%; background-repeat:no-repeat; position:absolute; left:0; top:0; background-size:cover; z-index:5; display:none;}
			#list > li.zIndex{ z-index:6;}
			#list > li:nth-of-type(1){ background-image:url(./images/b.png); display:block;}
			#list > li:nth-of-type(2){ background-image:url(./images/c.png);}
			#list > li:nth-of-type(3){ background-image:url(./images/d.png);}
			#list > li:nth-of-type(4){ background-image:url(./images/e.png);}
			#list > li:nth-of-type(5){ background-image:url(./images/ad1.png);}
			#list > li:nth-of-type(6){ background-image:url(./images/ad2.png);}
			#list > li:nth-of-type(7){ background-image:url(./images/ad3.png);}
			#list > li:nth-of-type(8){ background-image:url(./images/ad4.png);}
			#list .li1child{ font-size:30px; color:white; position:absolute; left:20%; top:65%;}
			#list .li2child li{ width:90px; height:90px; position:absolute;}

			#list .li2child li:nth-of-type(1){ background:url(./images/c1.png); left:43% ; top:30%;}
			#list .li2child li:nth-of-type(2){ background:url(./images/c2.png); left:13% ; top:40%;}
			#list .li2child li:nth-of-type(3){ background:url(./images/c3.png); left:73% ; top:40%;}
			#list .li2child li:nth-of-type(4){ background:url(./images/c4.png); left:13% ; top:65%;}
			#list .li2child li:nth-of-type(5){ background:url(./images/c5.png); left:73% ; top:65%;}
			#list .li2child li:nth-of-type(6){ background:url(./images/c6.png); left:43% ; top:75%;}
			#list .li2child li.active{ left:43%; top:52%;}
			#list .li3child{ width:460px; height:222px; background:url(./images/d1.png) no-repeat; position:absolute; left:50%; margin-left:-230px; top:60%;}
			#list .li4child li{ font-size:22px; color:white; border:1px #FFF solid; box-shadow:0 0 15px #FFF; border-radius:5px; word-wrap:break-word; position:absolute; overflow:hidden;}
			#list .li4child li:nth-of-type(1){ width:220px; height:240px; left:4%; top:15%;}
			#list .li4child li:nth-of-type(2){ width:280px; height:150px; left:50%; top:19%;}
			#list .li4child li:nth-of-type(3){ width:110px; height:280px; left:78%; top:40%;}
			#list .li4child li.active{ width:0; height:0;}

			#arrow{ width:90px; height:52px; background:url(./images/arr.png) no-repeat; position:absolute; bottom:20px; left:50%; margin-left:-45px; z-index:7; animation:1s infinite arrowTop; -webkit-animation:1.5s infinite arrowTop;}
			@-webkit-keyframes arrowTop{
				0%{ opacity:0; -webkit-transform:translate(0,0);}
				60%{ opacity:1; -webkit-transform:translate(0,-30px);}
				100%{ opacity:0; -webkit-transform:translate(0,-50px);}
			}
			@keyframes arrowTop{
				0%{ opacity:0; transform:translate(0,0);}
				60%{ opacity:1; transform:translate(0,-30px);}
				100%{ opacity:0; transform:translate(0,-50px);}
			}

			#music{ width:47px; height:47px; background:url(./images/music.png) no-repeat; background-size:cover; position:absolute; right:10px; top:10px; z-index:7;}
			#music.active{ -webkit-animation:1.5s infinite rotateMusic linear; animation:1.5s infinite rotateMusic linear;}
			@-webkit-keyframes rotateMusic{
				0%{ -webkit-transform:rotate(0);}
				100%{ -webkit-transform:rotate(360deg);}
			}
			@keyframes rotateMusic{
				0%{ transform:rotate(0);}
				100%{ transform:rotate(360deg);}
			}
			#loading{ width:100%; height:100%; background:white; position:absolute; left:0; top:0; z-index:20;}
			#loading div{ position:absolute; width:100%; top:50%; text-align:center; color:#0F0; font-size:30px;}
			#loading ul{ position:absolute; left:50%; top:40%; margin-left:-45px;}
			#loading ul li{ width:5px; height:40px; background:#0F0; float:left; margin-right:10px; -webkit-animation:2s infinite loading linear;animation:2s infinite loading linear;}
			@-webkit-keyframes loading{
				0%{ -webkit-transform:scaleY(1);}
				50%{ -webkit-transform:scaleY(0.1);}
				100%{ -webkit-transform:scaleY(1);}
			}
			@keyframes loading{
				0%{ -webkit-transform:scaleY(1);}
				50%{ -webkit-transform:scaleY(0.1);}
				100%{ -webkit-transform:scaleY(1);}
			}
			#loading ul li:nth-of-type(1){
				
			}
			#loading ul li:nth-of-type(2){
				-webkit-animation-delay:-0.2s;
				animation-delay:-0.2s;
			}
			#loading ul li:nth-of-type(3){
				-webkit-animation-delay:-0.4s;
				animation-delay:-0.4s;
			}
			#loading ul li:nth-of-type(4){
				-webkit-animation-delay:-0.6s;
				animation-delay:-0.6s;
			}
			#loading ul li:nth-of-type(5){
				-webkit-animation-delay:-0.8s;
				animation-delay:-0.8s;
			}
			#loading ul li:nth-of-type(6){
				-webkit-animation-delay:-1s;
				animation-delay:-1s;
			}
		</style>
		<script type="text/javascript" src="./script/libs/jquery-2.1.3.min.js"></script>
	</head>
	<body>
		<div style="display:none">
			<img src="./images/logo.jpg">
		</div>
		<div id="main">
			<div id="loading">
		    	<ul>
		        	<li></li>
		            <li></li>
		            <li></li>
		            <li></li>
		            <li></li>
		            <li></li>
		        </ul>
		        <div>你的技能是否已经载满...</div>
		    </div>
			<canvas id="canvas" width="640" height="960"></canvas>
			<ul id="list">
		    	<li>
		        	<ul class="li1child">
		            	<li>
		                	<p>曾经做为前端开发的你</p>
		                    <p>解决PC兼容性而焦头烂额</p>
		                </li>
		                <li>
		                	<p>而今</p>
		                    <p>移动端H5应用疯狂来袭</p>
		                </li>
		                <li>
		                	<p>你是否已准备充分</p>
		                    <p>学习新技能</p>
		                </li>
		                <li>
		                	<p>曾破茧成蝶、重获新生？</p>
		                </li>
		            </ul>
		        </li>
		        <li>
		        	<ul class="li2child">
		            	<li></li>
		                <li></li>
		                <li></li>
		                <li></li>
		                <li></li>
		                <li></li>
		            </ul>
		        </li>
		        <li>
		        	<div class="li3child"></div>
		        </li>
		        <li>
		        	<ul class="li4child">
		            	<li>transform  transition  rotate  scale  translate  keyframes animation  webkitTransitionEnd webkitAnimationIteration elapsedTime perspective…</li>
		                <li>drawImage lineWidth  strokeStyle  lineCap  globalCompositeOperation  moveTo   lineTo  stroke  arc  getImageData…</li>
		                <li>audio autoplay loop  paused  play  pause…</li>
		            </ul>
		        </li>
		        <li></li>
		        <li></li>
		        <li></li>
		        <li></li>
		    </ul>
		    <div id="arrow"></div>
		    <div id="music"></div>
		</div>
		<script type="text/javascript">
			$(document).on('touchmove',function(event){
				event.preventDefault();
			});
			$(function(){
				var viewHeight = $(window).height(),main = $('#main'),$li = $('#list').find('>li');
				function slideCanvas(){
					var canvasx,canvasy,image,istouch = true,canvas = $("#canvas"),nowviewidth = nowViewWidth(),context = canvas[0].getContext('2d');
					canvas.attr('height',viewHeight);
					image = new Image();
					image.src = './images/a.png';
					image.onload = function(){
						context.drawImage(image,(640 -nowviewidth)/2,0,nowviewidth,viewHeight);
						context.strokeStyle = 'blue';
						context.lineWidth = 60;
						context.lineCap = 'round';
						context.globalCompositeOperation = 'destination-out';
						canvasx =  canvas.offset().left;
						canvasy =  canvas.offset().top;
						canvas.on('touchstart',function(event){	
							var x,y,touch = event.originalEvent.changedTouches[0];
							x = touch.pageX - canvasx;
							y = touch.pageY - canvasy;
							if(istouch){
								istouch = false;
								context.moveTo(x,y);
								context.lineTo(x+1,y+1);
							}else{
								context.lineTo(x,y);
							}
							context.stroke();
							canvas.on('touchmove.move',function(event){	
								var x,y,touch = event.originalEvent.changedTouches[0];
								x = touch.pageX - canvasx;
								y = touch.pageY - canvasy;
								context.lineTo(x,y);
								context.stroke();
								
							});
							canvas.on('touchend.move',function(event){
								var allpx,sum = 0,imgData = context.getImageData(0,0,640,viewHeight);
								allpx = imgData.width * imgData.height;
								for(var i=0;i<allpx;i++){
									if(imgData.data[4*i+3] == 0 ){
										sum++;
									}
								}
								if(sum > allpx/4 ){
									canvas.animate({opacity:0},1000,function(){
										canvas.remove();
										cjAnimate[0].inAn();
									});
									createmusic();
								}
								canvas.off('.move');
							});
						});	
					};
				}
				
				function slideImg(){
					var startY = 0;
					var step = 1/4;
					var nowIndex = 0;
					var nextorprevIndex = 0;
					var bBtn = true;
					$li.css('backgroundPosition', (640 - nowViewWidth())/2 +'px 0');
					$li.on('touchstart',function(event){
						if(bBtn){
							bBtn = false;
							var touch = event.originalEvent.changedTouches[0];
							startY = touch.pageY;
							nowIndex = $(this).index();
							$li.on('touchmove.move',function(event){
								var touch = event.originalEvent.changedTouches[0];
								$(this).siblings().hide();
								if( touch.pageY < startY ){   //↑
									nextorprevIndex = nowIndex == $li.length-1 ? 0 : nowIndex + 1;
									$li.eq(nextorprevIndex).css('transform','translate(0,'+( viewHeight + touch.pageY - startY )+'px)');
								
								}
								else{   //↓
									nextorprevIndex = nowIndex == 0 ? $li.length-1 : nowIndex - 1;
									$li.eq(nextorprevIndex).css('transform','translate(0,'+( -viewHeight + touch.pageY - startY )+'px)');
								
								}
								$li.eq(nextorprevIndex).show().addClass('zIndex');
								//Math.abs((touch.pageY - startY))/viewHeight -> 最大值 -viewHeight~viewHeight
								$(this).css('transform','translate(0,'+ (touch.pageY - startY)*step +'px) scale('+(1 - Math.abs((touch.pageY - startY))*step/viewHeight )+')');
								
							});		
							$li.on('touchend.move',function(event){
								var touch = event.originalEvent.changedTouches[0];
								if( touch.pageY < startY ){   //↑
									$li.eq(nowIndex).css('transform','translate(0,'+(-viewHeight * step)+'px) scale('+(1 - step)+')');
								}
								else{  //↓
									$li.eq(nowIndex).css('transform','translate(0,'+(viewHeight * step)+'px) scale('+(1 - step)+')');
								}
								$li.eq(nowIndex).css('transition','.3s');
								$li.eq(nextorprevIndex).css('transform','translate(0,0)');
								$li.eq(nextorprevIndex).css('transition','.3s');
								$li.off('.move');
							});
						}
					});
					$li.on('transitionEnd webkitTransitionEnd',function(event){
						if(!$li.is(event.target)){ 
							return; 
						}
						resetFn();
						if(cjAnimate[nowIndex]){
							cjAnimate[nowIndex].outAn();
						}
						if(cjAnimate[nextorprevIndex]){
							cjAnimate[nextorprevIndex].inAn();
						}
					});
					function resetFn(){
						$li.css('transform','');
						$li.css('transition','');
						$li.eq(nextorprevIndex).removeClass('zIndex').siblings().hide();
						bBtn = true;
					}
				}
				
				function nowViewWidth(){
					var w = 640 * viewHeight / 960;
					w = w > 640 ? w : 640;
					return w;
				}
				var cjAnimate = [{
						inAn : function(){
							setTimeout(function(){
								var $liChild = $li.eq(0).find('li');
								$liChild.css('opacity',1);
								$liChild.css('transform','translate(0,0)');
								$liChild.css('transition','1s');
							},100);
						},
						outAn : function(){
							var $liChild = $li.eq(0).find('li');
							$liChild.css('opacity',0);
							$liChild.css('transition','');
							$liChild.filter(':odd').css('transform','translate(-200px,0)');
							$liChild.filter(':even').css('transform','translate(300px,0)');
						}
					},
					{
						inAn : function(){
							setTimeout(function(){
								var $liChild = $li.eq(1).find('li');
								$liChild.attr('class','');
								$liChild.css('transform','rotate(720deg)');
								$liChild.css('transition','1.5s');
							},100);
						},
						outAn : function(){
							var $liChild = $li.eq(1).find('li');
							$liChild.attr('class','active');
							$liChild.css('transform','');
							$liChild.css('transition','');
						}
					},
					{
						inAn : function(){
							setTimeout(function(){
								var $divChild = $li.eq(2).find('div');
								$divChild.css('transform','rotateY(720deg)');
								$divChild.css('transition','1.5s');
							},100);
						},
						outAn : function(){
							var $divChild = $li.eq(2).find('div');
							$divChild.css('transform','');
							$divChild.css('transition','');
							
						}
					},
					{
						inAn : function(){
							setTimeout(function(){
								var $liChild = $li.eq(3).find('li');
								$liChild.attr('class','');
								$liChild.css('transition','1s');
							},100);
						},
						outAn : function(){
							var $liChild = $li.eq(3).find('li');
							$liChild.attr('class','active');
							$liChild.css('transition','');
						}
					}
				];

				$.each(cjAnimate,function(i,obj){
					obj.outAn();
				});
				
				function createmusic(){
					var isplay = true,music = $('#music'),audio = document.createElement("audio");		
				    audio.src = "./music/music01.mp3";
				    audio.autoplay = false;
				    audio.loop = false;
				    audio.addEventListener("ended",function(){		    	
				    	audio.src = "./music/music01.mp3";
				    	audio.play();
				    });
				    music.addClass('active');
					music.on('touchstart',function(){
						if(isplay){
							music.css("animationPlayState","running");
							audio.play();
						}else{
							music.css("animationPlayState","paused");
							audio.pause();
						}
						isplay = !isplay;
					});
					music.trigger('touchstart');
				}
				function preloading(){
					var num = 0,list = ['a.png','b.png','c.png','d.png','e.png','ad1.png','ad2.png','ad3.png','ad4.png','c1.png','c2.png','c3.png','c4.png','c5.png','c6.png'];
					var len = list.length;
					$.each(list,function(i,src){
						var image = new Image();
						image.onload = function(){
							num++;
							if(num == len){
								$('#loading').animate({opacity : 0},1000,function(){
									$(this).remove();
								});
							}
						};
						image.onerror = function(){
							$('#loading').animate({opacity : 0},1000,function(){
								$(this).remove();
							});
						}
						image.src = './images/' + src;
					});
					list.length = 0;
					list = null;
				}
				function initApp(){
					main.css('height',viewHeight);
					preloading();
					slideCanvas();
					slideImg();						
				}
				initApp();
			});
		</script>
	</body>
</html>
